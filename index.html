<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÊàëÁöÑË∞∑Â≠êË®òÈåÑÁ∞ø v8 üéÄ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Zen Maru Gothic', sans-serif; }
        .file-input-hidden { display: none; }
        .menu-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .hover-zoom { transition: transform 0.2s; }
        .group:hover .hover-zoom { transform: scale(1.05); }
    </style>
</head>
<body class="bg-slate-50 text-slate-700 min-h-screen pb-24 md:pb-10">

    <div id="app" class="max-w-7xl mx-auto min-h-screen bg-white shadow-xl relative flex flex-col">
        
        <!-- È†ÇÈÉ®Â∞éËà™ -->
        <header class="bg-white/90 backdrop-blur-md sticky top-0 z-30 px-4 md:px-8 py-4 border-b border-pink-100 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <!-- Ê®ôÈ°å (ÂõûÊ≠∏‰∏≠ÊñáÔºåÊîØÊè¥ÁπÅÁ∞°ÂàáÊèõ) -->
                <h1 class="text-xl md:text-2xl font-bold text-pink-500 flex items-center gap-2 cursor-default">
                    üéÄ {{ t('appName') }}
                </h1>
                
                <!-- ÈõªËÖ¶ÁâàÊñ∞Â¢ûÊåâÈàï -->
                <button @click="showModal = true" class="hidden md:flex items-center gap-2 bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded-full text-sm font-bold transition shadow-md shadow-pink-200">
                    <span>üì∑</span> {{ t('addBtn') }}
                </button>
            </div>
            
            <div class="flex items-center gap-3">
                <!-- Ë™ûË®ÄÂàáÊèõ -->
                <button @click="toggleLang" class="text-xs font-bold px-2 py-1 rounded border border-pink-200 text-pink-400 hover:bg-pink-50 transition">
                    {{ lang === 'tw' ? 'ÁπÅ' : 'ÁÆÄ' }}
                </button>

                <!-- Ë®≠ÂÆöÈÅ∏ÂñÆ -->
                <div class="relative">
                    <button @click="showMenu = !showMenu" class="text-gray-500 hover:text-pink-500 p-2 transition rounded-full hover:bg-gray-100">
                        <span class="text-xl">‚öôÔ∏è</span>
                    </button>
                    
                    <div v-if="showMenu" class="absolute right-0 top-full mt-2 w-64 bg-white rounded-xl menu-shadow border border-pink-100 overflow-hidden z-40 animate-slide-up-sm">
                        <div class="p-3 border-b border-gray-50 bg-gray-50">
                            <p class="text-xs text-gray-400 font-bold">{{ t('menuTitle') }}</p>
                        </div>
                        <button @click="exportToCSV" class="w-full text-left px-4 py-3 text-sm hover:bg-pink-50 text-gray-700 flex items-center gap-2">
                            <span>üìä</span> {{ t('exportCSV') }}
                        </button>
                        <button @click="exportBackup" class="w-full text-left px-4 py-3 text-sm hover:bg-pink-50 text-gray-700 flex items-center gap-2 border-t border-gray-50">
                            <span>üíæ</span> {{ t('exportBackup') }}
                        </button>
                        <div class="relative border-t border-gray-50 group">
                            <button class="w-full text-left px-4 py-3 text-sm hover:bg-pink-50 text-pink-600 font-bold flex items-center gap-2 bg-pink-50/30">
                                <span>‚ôªÔ∏è</span> {{ t('importBackup') }}
                            </button>
                            <input type="file" @change="importBackup" accept=".json" class="absolute inset-0 opacity-0 cursor-pointer">
                        </div>
                        <button @click="resetTags" class="w-full text-left px-4 py-3 text-xs text-gray-400 hover:text-red-500 border-t border-gray-50">
                            üîÑ {{ t('resetTags') }}
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div v-if="showMenu" @click="showMenu = false" class="fixed inset-0 z-20"></div>

        <!-- ‰∏ªË¶ÅÂÖßÂÆπÂçÄ -->
        <div class="p-4 md:p-8 space-y-6 flex-1">
            
            <!-- Áµ±Ë®àÂç°Áâá -->
            <div class="bg-gradient-to-r from-pink-400 to-rose-400 rounded-2xl p-5 md:p-6 text-white shadow-lg shadow-pink-200 max-w-full">
                <div class="flex justify-between items-end">
                    <div class="flex items-center gap-4">
                        <div class="bg-white/20 p-3 rounded-full hidden md:block">
                            <span class="text-2xl">üíé</span>
                        </div>
                        <div>
                            <div class="text-pink-100 text-sm md:text-base">{{ t('totalCount') }}</div>
                            <div class="text-3xl md:text-4xl font-bold">{{ items.length }} <span class="text-sm font-normal">{{ t('unit') }}</span></div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-pink-100 text-sm md:text-base">{{ t('totalCost') }}</div>
                        <div class="text-2xl md:text-4xl font-bold">HK$ {{ formatNumber(totalCost) }}</div>
                    </div>
                </div>
            </div>

            <!-- Ë∞∑Â≠êÂàóË°® -->
            <div v-if="items.length > 0" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3 md:gap-6">
                <div v-for="(item, index) in items" :key="item.id" class="bg-white border border-pink-100 rounded-xl overflow-hidden shadow-sm relative group transition hover:shadow-xl hover:-translate-y-1 duration-300">
                    <button @click="removeItem(index)" class="absolute top-2 right-2 bg-black/50 hover:bg-red-500 text-white w-7 h-7 rounded-full flex items-center justify-center text-xs backdrop-blur-sm z-10 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition">‚úï</button>
                    
                    <div class="aspect-square bg-gray-100 relative overflow-hidden">
                        <img v-if="item.image" :src="item.image" class="w-full h-full object-cover hover-zoom">
                        <div v-else class="w-full h-full flex items-center justify-center text-pink-200 text-4xl">üì¶</div>
                    </div>
                    
                    <div class="p-3">
                        <!-- ‰ΩúÂìÅÂêç Tag -->
                        <div v-if="item.series" class="mb-1">
                            <span class="text-[10px] font-bold text-indigo-500 bg-indigo-50 px-2 py-0.5 rounded-md">{{ item.series }}</span>
                        </div>
                        
                        <h3 class="font-bold text-gray-800 truncate text-sm md:text-base" :title="item.name">{{ item.name }}</h3>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-xs px-2 py-0.5 bg-pink-50 text-pink-600 rounded-md truncate max-w-[80px]">{{ item.source }}</span>
                            <span class="text-sm font-bold text-rose-500">${{ item.price }}</span>
                        </div>
                        <div class="text-[10px] text-gray-400 mt-2 text-right">{{ item.date }}</div>
                    </div>
                </div>
            </div>

            <div v-else class="py-20 text-center text-gray-400">
                <div class="text-6xl mb-4 opacity-30">üì∑</div>
                <p class="text-lg font-medium">{{ t('emptyState') }}</p>
                <p class="text-sm mt-2 opacity-60">{{ t('emptyTip') }}</p>
            </div>
        </div>

        <!-- ÊâãÊ©üÊµÆÂãïÊåâÈàï -->
        <div class="md:hidden fixed bottom-8 left-0 right-0 flex justify-center z-20">
            <button @click="showModal = true" class="bg-pink-500 hover:bg-pink-600 text-white rounded-full p-4 shadow-xl shadow-pink-300/50 transition transform active:scale-95 flex items-center gap-2 px-6">
                <span class="text-2xl">üì∑</span>
                <span class="font-bold">{{ t('addBtn') }}</span>
            </button>
        </div>

        <!-- Êñ∞Â¢ûË®òÈåÑË¶ñÁ™ó -->
        <div v-if="showModal" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl p-6 animate-slide-up max-h-[90vh] overflow-y-auto shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">‚ú® {{ t('addTitle') }}</h2>
                    <button @click="closeModal" class="text-gray-400 hover:text-gray-600 text-2xl">‚úï</button>
                </div>

                <div class="space-y-4">
                    <!-- ÂúñÁâá -->
                    <div @click="triggerFileInput" class="w-full h-32 border-2 border-dashed border-pink-200 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-pink-50 transition relative overflow-hidden group">
                        <img v-if="form.image" :src="form.image" class="absolute inset-0 w-full h-full object-cover">
                        <div v-else class="text-center text-pink-400 group-hover:scale-110 transition">
                            <div class="text-2xl mb-1">üì∏</div>
                            <span class="text-xs font-bold">{{ t('photoTip') }}</span>
                        </div>
                        <input type="file" ref="fileInput" accept="image/*" class="file-input-hidden" @change="handleImageUpload">
                    </div>

                    <!-- 1. ‰ΩúÂìÅ/IPÂêç -->
                    <div>
                        <label class="text-xs font-bold text-indigo-500 ml-1">{{ t('labelSeries') }}</label>
                        <div class="flex flex-wrap gap-2 mt-1 mb-2 max-h-20 overflow-y-auto hide-scrollbar">
                            <button v-for="opt in currentSeriesList" :key="opt" 
                                @click="form.series = opt"
                                :class="form.series === opt ? 'bg-indigo-500 text-white shadow-md shadow-indigo-200' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'"
                                class="px-3 py-1 rounded-full text-xs font-medium transition">
                                {{ opt }}
                            </button>
                        </div>
                        <input v-model="form.series" type="text" class="w-full bg-gray-50 p-3 rounded-xl border-none focus:ring-2 focus:ring-indigo-300 outline-none" :placeholder="t('placeholderSeries')">
                    </div>

                    <!-- 2. Ë∞∑Â≠êÂêçÁ®± -->
                    <div>
                        <label class="text-xs font-bold text-gray-500 ml-1">{{ t('labelName') }}</label>
                        <input v-model="form.name" type="text" class="w-full bg-gray-50 p-3 rounded-xl border-none focus:ring-2 focus:ring-pink-300 outline-none" :placeholder="t('placeholderName')">
                    </div>

                    <!-- 3. ÂÉπÊ†ºËàáÊó•Êúü -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-gray-500 ml-1">{{ t('labelPrice') }}</label>
                            <input v-model.number="form.price" type="number" class="w-full bg-gray-50 p-3 rounded-xl border-none focus:ring-2 focus:ring-pink-300 outline-none" placeholder="0">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 ml-1">{{ t('labelDate') }}</label>
                            <input v-model="form.date" type="date" class="w-full bg-gray-50 p-3 rounded-xl border-none focus:ring-2 focus:ring-pink-300 outline-none">
                        </div>
                    </div>

                    <!-- 4. ÂÖ•ÊâãÈÄîÂæë -->
                    <div>
                        <label class="text-xs font-bold text-gray-500 ml-1">{{ t('labelSource') }}</label>
                        <div class="flex flex-wrap gap-2 mt-1 mb-2 max-h-20 overflow-y-auto hide-scrollbar">
                            <button v-for="opt in currentSourceList" :key="opt" 
                                @click="form.source = opt"
                                :class="form.source === opt ? 'bg-pink-500 text-white shadow-md shadow-pink-200' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'"
                                class="px-3 py-1 rounded-full text-xs font-medium transition">
                                {{ opt }}
                            </button>
                        </div>
                        <div class="relative">
                            <input v-model="form.source" type="text" class="w-full bg-gray-50 p-3 rounded-xl border-none focus:ring-2 focus:ring-pink-300 outline-none pl-9" :placeholder="t('placeholderSource')">
                            <span class="absolute left-3 top-3.5 text-gray-400">üè∑Ô∏è</span>
                        </div>
                    </div>

                    <button @click="saveItem" class="w-full bg-pink-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-pink-200 hover:bg-pink-600 transition mt-4">
                        {{ t('confirmBtn') }} ‚úÖ
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        const i18n = {
            'tw': {
                appName: 'ÊàëÁöÑË∞∑Â≠êË®òÈåÑÁ∞ø',
                menuTitle: 'Ë≥áÊñôÁÆ°ÁêÜ',
                exportCSV: 'ÂåØÂá∫ WPS Ë°®Ê†º (ÁÑ°Âúñ)',
                exportBackup: '‰∏ãËºâÂÆåÊï¥ÂÇô‰ªΩ (Âê´Âúñ)',
                importBackup: 'ÂÄíÂõû / ÂåØÂÖ•ËàäË≥áÊñô',
                resetTags: 'ÈáçÁΩÆÂ∏∏Áî®Ê®ôÁ±§',
                totalCount: 'Á∏ΩÊî∂ËóèÊï∏',
                unit: 'ÂÄã',
                totalCost: 'Á∏ΩËä±Ë≤ª',
                emptyState: 'ÈÄôË£°Á©∫Á©∫ÁöÑ...',
                emptyTip: 'ÈªûÊìäÊñ∞Â¢ûÊåâÈàïÔºåÈñãÂßãË®òÈåÑ‰Ω†ÁöÑË∞∑Â≠êÂêßÔºÅ',
                addBtn: 'Ë®ò‰∏ÄÁ≠Ü',
                addTitle: 'Êñ∞Â¢ûË∞∑Â≠ê',
                photoTip: 'ÈªûÊìäÊãçÁÖß / ÈÅ∏Âúñ',
                labelSeries: '‰ΩúÂìÅ/IPÂêç (ÈÅ∏Â°´)',
                placeholderSeries: '‰æãÂ¶ÇÔºöÊéíÁêÉÂ∞ëÂπ¥ / Chiikawa',
                labelName: 'Ë∞∑Â≠êÂêçÁ®±',
                placeholderName: '‰æãÂ¶ÇÔºöÊó•ÂêëÁøîÈôΩ ÂæΩÁ´†',
                labelPrice: 'ÂÖ•ÊâãÂÉπÊ†º',
                labelDate: 'ÂÖ•ÊâãÊó•Êúü',
                labelSource: 'ÂÖ•ÊâãÈÄîÂæë',
                placeholderSource: 'ÊàñÊòØËº∏ÂÖ•ÂÖ∂‰ªñÈÄîÂæë...',
                confirmBtn: 'Á¢∫Ë™çÊî∂Á¥ç',
                alertName: 'Ë´ãËº∏ÂÖ•Ë∞∑Â≠êÂêçÁ®±',
                alertFull: 'ÂÑ≤Â≠òÁ©∫ÈñìÂ∑≤ÊªøÔºÅË´ãÂÖàÂÇô‰ªΩÂæåÊ∏ÖÈô§ËàäÁÖßÁâá„ÄÇ',
                alertReset: 'Á¢∫ÂÆöË¶ÅÂ∞áÊâÄÊúâÊ®ôÁ±§ÊÅ¢Âæ©ÊàêÈ†êË®≠ÂÄºÂóéÔºü',
                alertNoData: 'Ê≤íÊúâË≥áÊñôÂèØÂåØÂá∫',
                alertImport: 'Ê™¢Ê∏¨Âà∞Ë≥áÊñôÔºåÁ¢∫ÂÆöË¶ÅÂÄíÂõûÂóéÔºü(ÈÄôÊúÉË¶ÜËìãÁèæÊúâË≥áÊñô)',
                alertSuccess: 'Ë≥áÊñôÂ∑≤ÊàêÂäüÈÇÑÂéüÔºÅ',
                alertError: 'ËÆÄÂèñÂ§±ÊïóÔºÅÊ†ºÂºèÈåØË™§„ÄÇ',
                defaultSources: ['ÈÄöË≤©', 'Á∑ö‰∏ãÂ∫ó', '‰∫§Êèõ', 'ÈñíÈ≠ö/Carousell', 'Êó•Êãç', 'Á¶ÆÁâ©'],
                defaultSeries: ['ÊéíÁêÉÂ∞ëÂπ¥', 'ËóçËâ≤Áõ£ÁçÑ', 'Chiikawa', 'ÂííË°ìËø¥Êà∞']
            },
            'cn': {
                appName: 'ÊàëÁöÑË∞∑Â≠êËÆ∞ÂΩïÁ∞ø',
                menuTitle: 'Êï∞ÊçÆÁÆ°ÁêÜ',
                exportCSV: 'ÂØºÂá∫ WPS Ë°®Ê†º (Êó†Âõæ)',
                exportBackup: '‰∏ãËΩΩÂÆåÊï¥Â§á‰ªΩ (Âê´Âõæ)',
                importBackup: 'ÊÅ¢Â§ç / ÂØºÂÖ•ÊóßÊï∞ÊçÆ',
                resetTags: 'ÈáçÁΩÆÂ∏∏Áî®Ê†áÁ≠æ',
                totalCount: 'ÊÄªÊî∂ËóèÊï∞',
                unit: '‰∏™',
                totalCost: 'ÊÄªËä±Ë¥π',
                emptyState: 'ËøôÈáåÁ©∫Á©∫ÁöÑ...',
                emptyTip: 'ÁÇπÂáªÊñ∞Â¢ûÊåâÈíÆÔºåÂºÄÂßãËÆ∞ÂΩï‰Ω†ÁöÑË∞∑Â≠êÂêßÔºÅ',
                addBtn: 'ËÆ∞‰∏ÄÁ¨î',
                addTitle: 'Êñ∞Â¢ûË∞∑Â≠ê',
                photoTip: 'ÁÇπÂáªÊãçÁÖß / ÈÄâÂõæ',
                labelSeries: '‰ΩúÂìÅ/IPÂêç (ÈÄâÂ°´)',
                placeholderSeries: '‰æãÂ¶ÇÔºöÊéíÁêÉÂ∞ëÂπ¥ / Chiikawa',
                labelName: 'Ë∞∑Â≠êÂêçÁß∞',
                placeholderName: '‰æãÂ¶ÇÔºöÊó•ÂêëÁøîÈò≥ ÂæΩÁ´†',
                labelPrice: 'ÂÖ•Êâã‰ª∑Ê†º',
                labelDate: 'ÂÖ•ÊâãÊó•Êúü',
                labelSource: 'ÂÖ•ÊâãÈÄîÂæÑ',
                placeholderSource: 'ÊàñÊòØËæìÂÖ•ÂÖ∂‰ªñÈÄîÂæÑ...',
                confirmBtn: 'Á°ÆËÆ§Êî∂Á∫≥',
                alertName: 'ËØ∑ËæìÂÖ•Ë∞∑Â≠êÂêçÁß∞',
                alertFull: 'Â≠òÂÇ®Á©∫Èó¥Â∑≤Êª°ÔºÅËØ∑ÂÖàÂ§á‰ªΩÂêéÊ∏ÖÈô§ÊóßÁÖßÁâá„ÄÇ',
                alertReset: 'Á°ÆÂÆöË¶ÅÂ∞ÜÊâÄÊúâÊ†áÁ≠æÊÅ¢Â§çÊàêÈªòËÆ§ÂÄºÂêóÔºü',
                alertNoData: 'Ê≤°ÊúâÊï∞ÊçÆÂèØÂØºÂá∫',
                alertImport: 'Ê£ÄÊµãÂà∞Êï∞ÊçÆÔºåÁ°ÆÂÆöË¶ÅÊÅ¢Â§çÂêóÔºü(ËøôÂ∞ÜË¶ÜÁõñÁé∞ÊúâÊï∞ÊçÆ)',
                alertSuccess: 'Êï∞ÊçÆÂ∑≤ÊàêÂäüËøòÂéüÔºÅ',
                alertError: 'ËØªÂèñÂ§±Ë¥•ÔºÅÊ†ºÂºèÈîôËØØ„ÄÇ',
                defaultSources: ['ÈÄöË¥©', 'Á∫ø‰∏ãÂ∫ó', '‰∫§Êç¢', 'Èó≤È±º/Carousell', 'Êó•Êãç', 'Á§ºÁâ©'],
                defaultSeries: ['ÊéíÁêÉÂ∞ëÂπ¥', 'ËìùËâ≤ÁõëÁã±', 'Chiikawa', 'ÂííÊúØÂõûÊàò']
            }
        };

        createApp({
            setup() {
                const lang = ref('tw');
                const showModal = ref(false);
                const showMenu = ref(false);
                const fileInput = ref(null);
                const items = ref([]);
                
                const sourceListTW = ref([...i18n.tw.defaultSources]);
                const sourceListCN = ref([...i18n.cn.defaultSources]);
                const seriesListTW = ref([...i18n.tw.defaultSeries]);
                const seriesListCN = ref([...i18n.cn.defaultSeries]);

                const form = ref({ name: '', series: '', price: '', date: new Date().toISOString().split('T')[0], source: '', image: null });

                const t = (key) => i18n[lang.value][key];
                const currentSourceList = computed(() => lang.value === 'tw' ? sourceListTW.value : sourceListCN.value);
                const currentSeriesList = computed(() => lang.value === 'tw' ? seriesListTW.value : seriesListCN.value);

                onMounted(() => {
                    const savedLang = localStorage.getItem('guzi_lang');
                    if (savedLang) lang.value = savedLang;
                    
                    const savedItems = localStorage.getItem('guzi_collection_v1');
                    if (savedItems) items.value = JSON.parse(savedItems);
                    
                    const savedTagsTW = localStorage.getItem('guzi_tags_tw');
                    const savedTagsCN = localStorage.getItem('guzi_tags_cn');
                    const savedSeriesTW = localStorage.getItem('guzi_series_tw');
                    const savedSeriesCN = localStorage.getItem('guzi_series_cn');

                    if (savedTagsTW) sourceListTW.value = JSON.parse(savedTagsTW);
                    if (savedTagsCN) sourceListCN.value = JSON.parse(savedTagsCN);
                    if (savedSeriesTW) seriesListTW.value = JSON.parse(savedSeriesTW);
                    if (savedSeriesCN) seriesListCN.value = JSON.parse(savedSeriesCN);
                });

                const toggleLang = () => {
                    lang.value = lang.value === 'tw' ? 'cn' : 'tw';
                    localStorage.setItem('guzi_lang', lang.value);
                    if(!form.value.source) form.value.source = currentSourceList.value[0];
                };

                watch(items, (newVal) => {
                    try { localStorage.setItem('guzi_collection_v1', JSON.stringify(newVal)); } 
                    catch (e) { alert(t('alertFull')); }
                }, { deep: true });

                watch(sourceListTW, (newVal) => localStorage.setItem('guzi_tags_tw', JSON.stringify(newVal)), { deep: true });
                watch(sourceListCN, (newVal) => localStorage.setItem('guzi_tags_cn', JSON.stringify(newVal)), { deep: true });
                watch(seriesListTW, (newVal) => localStorage.setItem('guzi_series_tw', JSON.stringify(newVal)), { deep: true });
                watch(seriesListCN, (newVal) => localStorage.setItem('guzi_series_cn', JSON.stringify(newVal)), { deep: true });

                const totalCost = computed(() => items.value.reduce((sum, item) => sum + (Number(item.price) || 0), 0));
                const triggerFileInput = () => fileInput.value.click();

                const handleImageUpload = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const maxWidth = 600;
                            let width = img.width; let height = img.height;
                            if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                            canvas.width = width; canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            form.value.image = canvas.toDataURL('image/jpeg', 0.7);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                };

                const saveItem = () => {
                    if (!form.value.name) { alert(t('alertName')); return; }
                    if (!form.value.source) form.value.source = currentSourceList.value[0];
                    
                    const currentSource = form.value.source.trim();
                    const currentSeries = form.value.series.trim();

                    if (lang.value === 'tw') {
                        if (currentSource && !sourceListTW.value.includes(currentSource)) sourceListTW.value.push(currentSource);
                        if (currentSeries && !seriesListTW.value.includes(currentSeries)) seriesListTW.value.push(currentSeries);
                    } else {
                        if (currentSource && !sourceListCN.value.includes(currentSource)) sourceListCN.value.push(currentSource);
                        if (currentSeries && !seriesListCN.value.includes(currentSeries)) seriesListCN.value.push(currentSeries);
                    }

                    items.value.unshift({ id: Date.now(), ...form.value });
                    closeModal();
                };

                const closeModal = () => {
                    showModal.value = false;
                    setTimeout(() => { form.value = { name: '', series: '', price: '', date: new Date().toISOString().split('T')[0], source: '', image: null }; }, 300);
                };

                const removeItem = (index) => { if(confirm('Delete?')) items.value.splice(index, 1); };

                const resetTags = () => {
                    if(confirm(t('alertReset'))) {
                        if (lang.value === 'tw') {
                            sourceListTW.value = [...i18n.tw.defaultSources];
                            seriesListTW.value = [...i18n.tw.defaultSeries];
                        } else {
                            sourceListCN.value = [...i18n.cn.defaultSources];
                            seriesListCN.value = [...i18n.cn.defaultSeries];
                        }
                        showMenu.value = false;
                    }
                };

                const formatNumber = (num) => num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

                const exportToCSV = () => {
                    if (items.value.length === 0) { alert(t('alertNoData')); return; }
                    let csvContent = "\uFEFFSeries,Name,Date,Source,Price\n";
                    items.value.forEach(item => {
                        const series = item.series ? `"${item.series.replace(/"/g, '""')}"` : "";
                        const name = `"${item.name.replace(/"/g, '""')}"`;
                        csvContent += `${series},${name},${item.date},${item.source},${item.price}\n`;
                    });
                    downloadFile(csvContent, 'text/csv;charset=utf-8;', `Guzi_List_${getTimestamp()}.csv`);
                    showMenu.value = false;
                };

                const exportBackup = () => {
                    if (items.value.length === 0) { alert(t('alertNoData')); return; }
                    const backupData = { 
                        items: items.value, 
                        tagsTW: sourceListTW.value, tagsCN: sourceListCN.value,
                        seriesTW: seriesListTW.value, seriesCN: seriesListCN.value
                    };
                    downloadFile(JSON.stringify(backupData), 'application/json', `Guzi_Backup_${getTimestamp()}.json`);
                    showMenu.value = false;
                };

                const importBackup = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const rawData = JSON.parse(e.target.result);
                            let importedItems = rawData.items || (Array.isArray(rawData) ? rawData : []);
                            if (confirm(t('alertImport'))) {
                                items.value = importedItems;
                                if (rawData.tagsTW) sourceListTW.value = rawData.tagsTW;
                                if (rawData.tagsCN) sourceListCN.value = rawData.tagsCN;
                                if (rawData.seriesTW) seriesListTW.value = rawData.seriesTW;
                                if (rawData.seriesCN) seriesListCN.value = rawData.seriesCN;
                                alert(t('alertSuccess'));
                            }
                        } catch (err) { alert(t('alertError')); }
                    };
                    reader.readAsText(file);
                    showMenu.value = false;
                    event.target.value = '';
                };

                const downloadFile = (content, type, filename) => {
                    const blob = new Blob([content], { type: type });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };

                const getTimestamp = () => new Date().toISOString().slice(0,16).replace(/[-T:]/g, '');

                return {
                    lang, t, toggleLang, currentSourceList, currentSeriesList,
                    showModal, showMenu, items, form, fileInput, totalCost,
                    triggerFileInput, handleImageUpload, saveItem, closeModal, removeItem, formatNumber,
                    exportToCSV, exportBackup, importBackup, resetTags
                };
            }
        }).mount('#app');
    </script>
    
    <style>
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes slide-up-sm { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slide-up 0.3s ease-out; }
        .animate-slide-up-sm { animation: slide-up-sm 0.2s ease-out; }
    </style>
</body>
</html>
