<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„è°·å­è¨˜éŒ„ç°¿ ğŸ€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- å¼•å…¥å¯æ„›çš„åœ“é«”å­—å‹ -->
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Zen Maru Gothic', sans-serif; }
        /* éš±è—æª”æ¡ˆè¼¸å…¥æ¡† */
        .file-input-hidden { display: none; }
    </style>
</head>
<body class="bg-pink-50 text-slate-700 min-h-screen pb-20">

    <div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-xl relative">
        
        <!-- é ‚éƒ¨å°èˆª -->
        <header class="bg-white/80 backdrop-blur-md sticky top-0 z-10 px-6 py-4 border-b border-pink-100 flex justify-between items-center">
            <h1 class="text-xl font-bold text-pink-500">ğŸ€ My Guzi Log</h1>
            <button @click="exportToCSV" class="text-xs bg-green-100 text-green-700 px-3 py-1.5 rounded-full font-bold hover:bg-green-200 transition flex items-center gap-1">
                <span>ğŸ“¥ åŒ¯å‡ºè¡¨æ ¼ (WPS)</span>
            </button>
        </header>

        <!-- å…§å®¹åˆ—è¡¨å€ -->
        <div class="p-4 space-y-4">
            <!-- çµ±è¨ˆå¡ç‰‡ -->
            <div class="bg-gradient-to-r from-pink-400 to-rose-400 rounded-2xl p-5 text-white shadow-lg shadow-pink-200">
                <div class="flex justify-between items-end">
                    <div>
                        <div class="text-pink-100 text-sm">ç¸½æ”¶è—æ•¸</div>
                        <div class="text-3xl font-bold">{{ items.length }} <span class="text-sm font-normal">å€‹</span></div>
                    </div>
                    <div class="text-right">
                        <div class="text-pink-100 text-sm">ç¸½èŠ±è²»</div>
                        <div class="text-2xl font-bold">HK$ {{ formatNumber(totalCost) }}</div>
                    </div>
                </div>
            </div>

            <!-- åˆ—è¡¨ -->
            <div v-if="items.length > 0" class="grid grid-cols-2 gap-3">
                <div v-for="(item, index) in items" :key="item.id" class="bg-white border border-pink-100 rounded-xl overflow-hidden shadow-sm relative group">
                    <!-- åˆªé™¤æŒ‰éˆ• -->
                    <button @click="removeItem(index)" class="absolute top-2 right-2 bg-black/30 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs backdrop-blur-sm z-10">âœ•</button>
                    
                    <!-- åœ–ç‰‡é¡¯ç¤º -->
                    <div class="aspect-square bg-gray-100 relative overflow-hidden">
                        <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                        <div v-else class="w-full h-full flex items-center justify-center text-pink-200 text-4xl">ğŸ“¦</div>
                    </div>
                    
                    <!-- è³‡è¨Š -->
                    <div class="p-3">
                        <h3 class="font-bold text-gray-800 truncate text-sm">{{ item.name }}</h3>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-xs px-2 py-0.5 bg-pink-50 text-pink-600 rounded-md">{{ item.source }}</span>
                            <span class="text-sm font-bold text-rose-500">${{ item.price }}</span>
                        </div>
                        <div class="text-[10px] text-gray-400 mt-2 text-right">{{ item.date }}</div>
                    </div>
                </div>
            </div>

            <div v-else class="py-10 text-center text-gray-400">
                <div class="text-4xl mb-2">ğŸ“·</div>
                <p>é‚„æ²’æœ‰è¨˜éŒ„å–”ï¼Œå¿«å»æ‹å¼µç…§å§ï¼</p>
            </div>
        </div>

        <!-- åº•éƒ¨æµ®å‹•æŒ‰éˆ• (FAB) -->
        <div class="fixed bottom-6 left-0 right-0 flex justify-center z-20">
            <button @click="showModal = true" class="bg-pink-500 hover:bg-pink-600 text-white rounded-full p-4 shadow-xl shadow-pink-300/50 transition transform active:scale-95 flex items-center gap-2 px-6">
                <span class="text-2xl">ğŸ“·</span>
                <span class="font-bold">è¨˜ä¸€ç­†</span>
            </button>
        </div>

        <!-- æ–°å¢è¨˜éŒ„è¦–çª— (Modal) -->
        <div v-if="showModal" class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl p-6 animate-slide-up max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">âœ¨ æ–°å¢è°·å­</h2>
                    <button @click="closeModal" class="text-gray-400 hover:text-gray-600 text-2xl">âœ•</button>
                </div>

                <div class="space-y-4">
                    <!-- æ‹ç…§/ä¸Šå‚³å€ -->
                    <div @click="triggerFileInput" class="w-full h-40 border-2 border-dashed border-pink-200 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-pink-50 transition relative overflow-hidden">
                        <img v-if="form.image" :src="form.image" class="absolute inset-0 w-full h-full object-cover">
                        <div v-else class="text-center text-pink-400">
                            <div class="text-3xl mb-1">ğŸ“¸</div>
                            <span class="text-sm font-bold">é»æ“Šæ‹ç…§ / é¸åœ–</span>
                        </div>
                        <input type="file" ref="fileInput" accept="image/*" class="file-input-hidden" @change="handleImageUpload">
                    </div>

                    <div>
                        <label class="text-xs font-bold text-gray-500 ml-1">è°·å­åç¨±</label>
                        <input v-model="form.name" type="text" class="w-full bg-gray-50 p-3 rounded-xl border-none focus:ring-2 focus:ring-pink-300 outline-none" placeholder="ä¾‹å¦‚ï¼šæ’çƒå°‘å¹´ å¾½ç« ">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-gray-500 ml-1">å…¥æ‰‹åƒ¹æ ¼</label>
                            <input v-model.number="form.price" type="number" class="w-full bg-gray-50 p-3 rounded-xl border-none focus:ring-2 focus:ring-pink-300 outline-none" placeholder="0">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 ml-1">å…¥æ‰‹æ—¥æœŸ</label>
                            <input v-model="form.date" type="date" class="w-full bg-gray-50 p-3 rounded-xl border-none focus:ring-2 focus:ring-pink-300 outline-none">
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-gray-500 ml-1">å…¥æ‰‹é€”å¾‘</label>
                        <div class="flex flex-wrap gap-2 mt-1">
                            <button v-for="opt in sourceOptions" :key="opt" 
                                @click="form.source = opt"
                                :class="form.source === opt ? 'bg-pink-500 text-white' : 'bg-gray-100 text-gray-500'"
                                class="px-3 py-1.5 rounded-lg text-sm font-medium transition">
                                {{ opt }}
                            </button>
                        </div>
                        <input v-if="!sourceOptions.includes(form.source) && form.source !== ''" v-model="form.source" type="text" class="mt-2 w-full bg-gray-50 p-2 rounded-lg text-sm" placeholder="è‡ªè¨‚é€”å¾‘...">
                    </div>

                    <button @click="saveItem" class="w-full bg-pink-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-pink-200 hover:bg-pink-600 transition mt-4">
                        ç¢ºèªæ”¶ç´ âœ…
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const showModal = ref(false);
                const fileInput = ref(null);
                const items = ref([]);
                
                const sourceOptions = ['é€šè²©', 'ç·šä¸‹åº—', 'äº¤æ›', 'é–’é­š/Carousell', 'æ—¥æ‹', 'ç¦®ç‰©'];

                // è¡¨å–®è³‡æ–™
                const form = ref({
                    name: '',
                    price: '',
                    date: new Date().toISOString().split('T')[0],
                    source: 'é€šè²©',
                    image: null
                });

                // åˆå§‹åŒ–
                onMounted(() => {
                    const saved = localStorage.getItem('guzi_collection_v1');
                    if (saved) items.value = JSON.parse(saved);
                });

                // è‡ªå‹•å­˜æª”
                watch(items, (newVal) => {
                    try {
                        localStorage.setItem('guzi_collection_v1', JSON.stringify(newVal));
                    } catch (e) {
                        alert('å„²å­˜ç©ºé–“å·²æ»¿ï¼å»ºè­°åˆªé™¤èˆŠè¨˜éŒ„æˆ–åŒ¯å‡ºè¡¨æ ¼å¾Œæ¸…ç©ºã€‚');
                    }
                }, { deep: true });

                const totalCost = computed(() => {
                    return items.value.reduce((sum, item) => sum + (Number(item.price) || 0), 0);
                });

                // è§¸ç™¼æª”æ¡ˆé¸æ“‡
                const triggerFileInput = () => {
                    fileInput.value.click();
                };

                // åœ–ç‰‡å£“ç¸®è™•ç† (é—œéµæŠ€è¡“ï¼šé˜²æ­¢ LocalStorage çˆ†æ»¿)
                const handleImageUpload = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            // å»ºç«‹ Canvas é€²è¡Œå£“ç¸®
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // è¨­å®šæœ€å¤§å¯¬åº¦ (ä¾‹å¦‚ 600pxï¼Œæ‰‹æ©Ÿçœ‹å¤ æ¸…æ¥šäº†)
                            const maxWidth = 600;
                            let width = img.width;
                            let height = img.height;

                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }

                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);

                            // è½‰æˆ Base64 JPEGï¼Œå“è³ª 0.7
                            form.value.image = canvas.toDataURL('image/jpeg', 0.7);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                };

                const saveItem = () => {
                    if (!form.value.name) {
                        alert('è«‹è¼¸å…¥è°·å­åç¨±');
                        return;
                    }

                    items.value.unshift({
                        id: Date.now(),
                        ...form.value
                    });

                    closeModal();
                };

                const closeModal = () => {
                    showModal.value = false;
                    // é‡ç½®è¡¨å–®
                    setTimeout(() => {
                        form.value = {
                            name: '',
                            price: '',
                            date: new Date().toISOString().split('T')[0],
                            source: 'é€šè²©',
                            image: null
                        };
                    }, 300);
                };

                const removeItem = (index) => {
                    if(confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹è°·å­è¨˜éŒ„å—ï¼Ÿ')) {
                        items.value.splice(index, 1);
                    }
                };

                const formatNumber = (num) => num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

                // åŒ¯å‡º CSV (WPS å¯è®€)
                const exportToCSV = () => {
                    if (items.value.length === 0) {
                        alert('é‚„æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡ºå–”ï¼');
                        return;
                    }

                    // CSV æ¨™é ­ (åŠ å…¥ \uFEFF æ˜¯ç‚ºäº†è®“ Excel/WPS æ­£ç¢ºè­˜åˆ¥ä¸­æ–‡ç·¨ç¢¼)
                    let csvContent = "\uFEFFè°·å­åç¨±,å…¥æ‰‹æ—¥æœŸ,é€”å¾‘,åƒ¹æ ¼(HKD)\n";

                    items.value.forEach(item => {
                        // è™•ç†åç¨±ä¸­å¯èƒ½å«æœ‰çš„é€—è™Ÿï¼Œç”¨å¼•è™ŸåŒ…èµ·ä¾†
                        const name = `"${item.name.replace(/"/g, '""')}"`;
                        const row = `${name},${item.date},${item.source},${item.price}`;
                        csvContent += row + "\n";
                    });

                    // å»ºç«‹ä¸‹è¼‰é€£çµ
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    
                    // æª”ååŠ å…¥æ—¥æœŸ
                    const dateStr = new Date().toISOString().split('T')[0];
                    link.setAttribute('href', url);
                    link.setAttribute('download', `è°·å­è¨˜éŒ„è¡¨_${dateStr}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };

                return {
                    showModal, items, form, fileInput, sourceOptions, totalCost,
                    triggerFileInput, handleImageUpload, saveItem, closeModal, removeItem, formatNumber, exportToCSV
                };
            }
        }).mount('#app');
    </script>
    
    <style>
        /* ç°¡å–®çš„å‹•ç•« */
        @keyframes slide-up {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .animate-slide-up {
            animation: slide-up 0.3s ease-out;
        }
    </style>
</body>
</html>
